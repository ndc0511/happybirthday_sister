<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Ghép Ảnh Sinh Nhật</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Pacifico|Quicksand:400,700&display=swap">
    <link rel="stylesheet" href="../src/styles.css">
    <style>
        body {
            min-height: 100vh;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f8ffae 0%, #43c6ac 100%);
            font-family: 'Quicksand', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        .puzzle-title {
            font-family: 'Pacifico', cursive;
            font-size: 2.5em;
            color: #ff69b4;
            margin-top: 40px;
            margin-bottom: 10px;
            text-shadow: 0 0 18px #fff176, 0 2px 8px #ff69b4;
            letter-spacing: 2px;
            animation: glow 2s infinite alternate;
        }
        @keyframes glow {
            from { text-shadow: 0 0 18px #fff176, 0 2px 8px #ff69b4; }
            to   { text-shadow: 0 0 32px #ffd700, 0 2px 16px #ff69b4; }
        }
        .controls {
            text-align: center;
            margin-bottom: 18px;
        }
        .puzzle-container {
            width: 480px;
            height: 480px;
            margin: 0 auto 20px auto;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 8px;
            background: rgba(255,255,255,0.7);
            border-radius: 28px;
            box-shadow: 0 8px 32px #ffb6c1aa, 0 1.5px 8px #ffd70088;
            position: relative;
        }
        .piece {
            width: 158px;
            height: 158px;
            background-image: url('../src/anh1.jpg');
            background-size: 474px 474px;
            border-radius: 18px;
            box-shadow: 0 2px 10px #ffd70055;
            cursor: pointer;
            transition: box-shadow 0.2s, transform 0.2s, filter 0.2s;
            user-select: none;
            border: 2px solid #fff;
            background-color: #fff;
        }
        .piece:hover:not(.empty) {
            box-shadow: 0 4px 24px #ff69b4bb;
            filter: brightness(1.08);
            transform: scale(1.06) rotate(-2deg);
            z-index: 2;
        }
        .piece.empty {
            background: linear-gradient(135deg, #f8ffae 0%, #43c6ac 100%);
            cursor: default;
            box-shadow: none;
            border: 2px dashed #ffd700;
        }
        .piece.correct {
            box-shadow: 0 0 16px #4caf50, 0 2px 10px #ffd70055;
            border: 2px solid #4caf50;
            animation: win-glow 1.2s infinite alternate;
        }
        @keyframes win-glow {
            from { box-shadow: 0 0 16px #4caf50, 0 2px 10px #ffd70055; }
            to   { box-shadow: 0 0 32px #4caf50, 0 2px 20px #ffd70099; }
        }
        .back-btn, .shuffle-btn {
            margin: 18px 8px 0 8px;
            padding: 12px 32px;
            font-size: 1.1em;
            border-radius: 12px;
            border: none;
            background: linear-gradient(90deg, #ff69b4 60%, #ffd700 100%);
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 8px #ffd70055;
            transition: background 0.2s, color 0.2s, transform 0.15s;
            outline: none;
        }
        .back-btn:hover, .shuffle-btn:hover, .back-btn:focus, .shuffle-btn:focus {
            background: linear-gradient(90deg, #ffd700 60%, #ff69b4 100%);
            color: #ff69b4;
            transform: translateY(-2px) scale(1.04);
            box-shadow: 0 4px 16px #ff69b4aa;
        }
        #message {
            margin-left: 0;
            color: #4caf50;
            font-weight: bold;
            font-size: 1.2em;
            margin-top: 10px;
            min-height: 32px;
            display: block;
            text-align: center;
            text-shadow: 0 1px 0 #fff;
        }
        @media (max-width: 700px) {
            .puzzle-container { width: 98vw; height: 98vw; min-width: 0; min-height: 0; }
            .piece { width: 30vw; height: 30vw; background-size: 90vw 90vw; }
        }
    </style>
</head>
<body>
    <div class="puzzle-title">🧩 Ghép Ảnh Sinh Nhật</div>
    <div class="controls">
        <button class="shuffle-btn" onclick="shufflePuzzle()">Xáo Trộn</button>
        <span id="countdown" style="font-size:2em; color:#ff69b4; font-weight:bold; margin-left:18px; display:none;"></span>
        <span id="message"></span>
    </div>
    <div class="puzzle-container" id="puzzle"></div>
    <div style="text-align:center;">
        <button class="back-btn" onclick="window.location.href='index.html'">Quay lại Trang Chủ</button>
    </div>
    <script>
        const ROWS = 3, COLS = 3;
        const puzzle = document.getElementById('puzzle');
        const message = document.getElementById('message');
        const countdown = document.getElementById('countdown');
        let pieces = [];
        let emptyIndex = null;

        function createPieces() {
            pieces = [];
            for (let i = 0; i < ROWS * COLS; i++) {
                pieces.push(i);
            }
        }

        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }

        function renderPuzzle() {
            puzzle.innerHTML = '';
            for (let i = 0; i < pieces.length; i++) {
                const idx = pieces[i];
                const div = document.createElement('div');
                div.className = 'piece';
                div.dataset.index = i;
                if (idx === ROWS * COLS - 1) {
                    div.classList.add('empty');
                    emptyIndex = i;
                } else {
                    const row = Math.floor(idx / COLS);
                    const col = idx % COLS;
                    div.style.backgroundPosition = `-${col*158}px -${row*158}px`;
                    div.draggable = true;
                    div.addEventListener('dragstart', dragStart);
                    div.addEventListener('dragover', dragOver);
                    div.addEventListener('drop', drop);
                    div.addEventListener('dragend', dragEnd);
                    div.addEventListener('click', pieceClick);
                }
                puzzle.appendChild(div);
            }
        }

        function isNeighbor(i1, i2) {
            const r1 = Math.floor(i1 / COLS), c1 = i1 % COLS;
            const r2 = Math.floor(i2 / COLS), c2 = i2 % COLS;
            return (r1 === r2 && Math.abs(c1 - c2) === 1) || (c1 === c2 && Math.abs(r1 - r2) === 1);
        }

        function pieceClick(e) {
            const idx = Number(this.dataset.index);
            if (isNeighbor(idx, emptyIndex)) {
                [pieces[idx], pieces[emptyIndex]] = [pieces[emptyIndex], pieces[idx]];
                renderPuzzle();
                checkWin();
            }
        }

        let draggedIndex = null;
        function dragStart(e) {
            draggedIndex = Number(this.dataset.index);
            this.classList.add('dragging');
        }
        function dragOver(e) {
            e.preventDefault();
            const idx = Number(this.dataset.index);
            if (!this.classList.contains('empty') && !isNeighbor(idx, emptyIndex)) {
                e.dataTransfer.dropEffect = "none";
            }
        }
        function drop(e) {
            const idx = Number(this.dataset.index);
            if (this.classList.contains('empty') && isNeighbor(draggedIndex, idx)) {
                [pieces[draggedIndex], pieces[idx]] = [pieces[idx], pieces[draggedIndex]];
                renderPuzzle();
                checkWin();
            }
        }
        function dragEnd(e) {
            this.classList.remove('dragging');
        }

        function checkWin() {
            let win = true;
            for (let i = 0; i < pieces.length; i++) {
                if (pieces[i] !== i) {
                    win = false;
                    break;
                }
            }
            if (win) {
                message.textContent = "🎉 Chúc mừng chị gái của em giỏi quá! 🎉";
                document.querySelectorAll('.piece').forEach((el, i) => {
                    if (!el.classList.contains('empty')) el.classList.add('correct');
                });
            } else {
                message.textContent = "";
            }
        }

        function shufflePuzzle() {
            createPieces();
            do {
                shuffleArray(pieces);
            } while (!isSolvable(pieces) || isSolved(pieces));
            renderPuzzle();
            message.textContent = "";
            // Đếm ngược khi bắt đầu xáo trộn
            countdown.style.display = '';
            let t = 3;
            countdown.textContent = `Bắt đầu sau ${t}...`;
            const interval = setInterval(() => {
                t--;
                if (t > 0) {
                    countdown.textContent = `Bắt đầu sau ${t}...`;
                } else {
                    countdown.textContent = "";
                    countdown.style.display = 'none';
                    clearInterval(interval);
                }
            }, 1000);
        }

        function isSolved(arr) {
            for (let i = 0; i < arr.length; i++) {
                if (arr[i] !== i) return false;
            }
            return true;
        }

        function isSolvable(arr) {
            let inv = 0;
            for (let i = 0; i < arr.length - 1; i++) {
                for (let j = i + 1; j < arr.length; j++) {
                    if (arr[i] !== ROWS*COLS-1 && arr[j] !== ROWS*COLS-1 && arr[i] > arr[j]) inv++;
                }
            }
            return inv % 2 === 0;
        }

        shufflePuzzle();
    </script>
</body>
</html>
